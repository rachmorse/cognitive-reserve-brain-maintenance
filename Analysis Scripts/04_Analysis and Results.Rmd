---
title: "Results"
output:
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
if (!require("ggplot2")) {
  install.packages("ggplot2")
  require("ggplot2")
}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("tidyr")) {
  install.packages("tidyr")
  require("tidyr")
}
if (!require("knitr")) {
  install.packages("knitr")
  require("knitr")
}
if (!require("patchwork")) {
  install.packages("patchwork")
  require("patchwork")
}
if (!require("mgcv")) {
  install.packages("mgcv")
  require("mgcv")
}
if (!require("lme4")) {
  install.packages("lme4")
  require("lme4")
}
if (!require("lmerTest")) {
  install.packages("lmerTest")
  require("lmerTest")
}
if (!require("gamm4")) {
  install.packages("gamm4")
  require("gamm4")
}
if (!require("ggbeeswarm")) {
  install.packages("ggbeeswarm")
  require("ggbeeswarm")
}
if (!require("emmeans")) {
  install.packages("emmeans")
  require("emmeans")
}
if (!require("ggeffects")) {
  install.packages("ggeffects")
  require("ggeffects")
}
if (!require("ggnewscale")) {
  install.packages("ggnewscale")
  require("ggnewscale")
}
if (!require("broom")) {
  install.packages("broom")
  require("broom")
}
```

```{r echo=FALSE, warning=FALSE}
clean_data <- read.csv("/tsd/p274/data/durable/projects/p027-cr_bm/Clean Data All Cohorts/Wide Format/Analysed data.csv")

p_value_df <- read.csv("/tsd/p274/data/durable/projects/p027-cr_bm/p_value.csv")

# Change the p-values to none scientific format
p_value_df$adjusted_p_value <- as.numeric(format(p_value_df$adjusted_p_value, scientific = FALSE))
```

```{r echo=FALSE}
participants <- clean_data %>% nrow()
female <- (clean_data %>% filter(clean_data$sex == "female") %>% nrow())
female_percentage <- (female / participants) * 100
mean_age <- mean(clean_data$age_baseline, na.rm = TRUE)
sd_age <- sd(clean_data$age_baseline, na.rm = TRUE)

# Create a new variable to represent average follow-up time
clean_data <- clean_data %>%
  mutate(FU_time = rowMeans(select(., mem_time, hc_time, fc_time), na.rm = TRUE))

mean_fu <- mean(clean_data$FU_time, na.rm = TRUE)
sd_fu <- sd(clean_data$FU_time, na.rm = TRUE)
```

```{r echo=FALSE}
# Helper function to format p-values
format_p_value <- function(p) {
  if (p < 0.001) {
    return("<0.001") # Written like this because of HTML formatting
  } else {
    return(round(p, 3))
  }
}

# Helper function to perform ANOVA and extract required statistics
get_aov_stats <- function(formula, data, vars_priority) {
  model <- aov(formula, data = data)
  summary_model <- summary(model)
  
  # Access the ANOVA table
  anova_table <- summary_model[[1]]
  
  # Clean up row names to remove whitespace
  rownames(anova_table) <- trimws(rownames(anova_table))
  
  # Check each variable in priority order and break on the first match
  for (var in vars_priority) {
    if (var %in% rownames(anova_table)) {
      p_value <- anova_table[var, "Pr(>F)"]
      return(list(p_value = p_value))
    }
  }
  
  stop("None of the priority variables are in the model.")
}

# Set a list of priority variables
vars <- c("cohort")

# Call the function
mmse_model <- get_aov_stats(mmse ~ cohort, data = clean_data, vars_priority = vars)

# Age baseline
age_model <- get_aov_stats(age_baseline ~ cohort, data = clean_data, vars)

# Sex
chisq_test <- chisq.test(clean_data$sex, clean_data$cohort)
chisq_test$p_value <- chisq_test$p.value

# Education
edu_model <- get_aov_stats(edu ~ cohort, data = clean_data, vars)

# FU time
fu_time_model <- get_aov_stats(FU_time ~ cohort, data = clean_data, vars)

# FU observations
fu_obs_model <- get_aov_stats(FU_obs ~ cohort, data = clean_data, vars)
```

We included `r participants` participants: `r round(female_percentage, 2)`% female with a mean baseline age of `r round(mean_age, 2)` years (SD = `r round(sd_age, 2)`) and a mean follow-up time of `r round(mean_fu, 2)` years (SD = `r round(sd_fu, 2)`). The descriptive statistics are summarized by cohort in Table 3. At least two cohorts varied significantly on baseline age (_p_ = `r format_p_value(age_model$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "age_model", "adjusted_p_value"])`), sex (_p_ = `r format_p_value(chisq_test$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "chisq_test", "adjusted_p_value"])`), education (_p_ = `r format_p_value(edu_model$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "edu_model", "adjusted_p_value"])`), MMSE (_p_ = `r format_p_value(mmse_model$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "mmse_model", "adjusted_p_value"])`), follow-up time (_p_ = `r format_p_value(fu_time_model$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "fu_time_model", "adjusted_p_value"])`), and follow-up observations (_p_ = `r format_p_value(fu_obs_model$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "fu_obs_model", "adjusted_p_value"])`).

```{r echo=FALSE}
# Create a new variable to represent average number of follow-ups
clean_data <- clean_data %>%
  mutate(FU_obs = rowMeans(select(., em_obs, hc_obs, fc_obs), na.rm = TRUE))

clean_data <- clean_data %>%
  mutate(Study = recode(cohort,
    "Betula" = "Umea Betula",
    "Cobra" = "Umea COBRA",
    "Oslo" = "Oslo LCBC",
    "WAHA" = "Barcelona WAHA"
  ))

summary_stats <- clean_data %>%
  # Create a custom order for the table
  mutate(Study = factor(Study, levels = c("Barcelona WAHA", "Oslo LCBC", "Umea Betula", "Umea COBRA"))) %>%
  arrange(Study)

summary_stats <- summary_stats %>%
  dplyr::group_by(Study) %>%
  dplyr::summarise(
    `**Participants**` = n_distinct(id),
    `**Baseline age [mean (range)]**` = paste0(
      round(mean(age_baseline, na.rm = T), digits = 1),
      " (", paste0(round(range(age_baseline, na.rm = T)),
        collapse = "-"
      ),
      ")"
    ),
    `**Sex [%F/%M]**` = paste0(
      c(
        round(mean(sex == "female", na.rm = T) * 100),
        round(mean(sex == "male", na.rm = T) * 100)
      ),
      collapse = "/"
    ),
    `**Education [mean (range)]**` = paste0(
      round(mean(edu, na.rm = T), digits = 1),
      " (", paste0(round(range(edu, na.rm = T)),
        collapse = "-"
      ),
      ")"
    ),
    `**MMSE [mean (range)]**` = paste0(
      round(mean(mmse, na.rm = T), digits = 1),
      " (", paste0(round(range(mmse, na.rm = T)),
        collapse = "-"
      ),
      ")"
    ),
    `**Follow-up time [mean (range)]**` = paste0(
      round(mean(FU_time, na.rm = T), digits = 1),
      " (", paste0(round(range(FU_time, na.rm = T)),
        collapse = "-"
      ),
      ")"
    ),
    `**Follow-up observations [mean (range)]**` = paste0(
      round(mean(FU_obs, na.rm = TRUE), digits = 1),
      " (",
      "2",
      "-",
      round(max(FU_obs, na.rm = TRUE)),
      ")"
    )
  )

# Create a data frame for the total line
total_line <- tibble::tibble(
  `Study` = "Total",
  `**Participants**` = n_distinct(clean_data$id),
  `**Baseline age [mean (range)]**` = paste0(
    round(mean(clean_data$age_baseline, na.rm = T), digits = 1),
    " (", paste0(round(range(clean_data$age_baseline, na.rm = T)),
      collapse = "-"
    ),
    ")"
  ),
  `**Sex [%F/%M]**` = paste0(
    c(
      round(mean(clean_data$sex == "female", na.rm = T) * 100),
      round(mean(clean_data$sex == "male", na.rm = T) * 100)
    ),
    collapse = "/"
  ),
  `**Education [mean (range)]**` = paste0(
    round(mean(clean_data$edu, na.rm = T), digits = 1),
    " (", paste0(round(range(clean_data$edu, na.rm = T)),
      collapse = "-"
    ),
    ")"
  ),
  `**MMSE [mean (range)]**` = paste0(
    round(mean(clean_data$mmse, na.rm = T), digits = 1),
    " (", paste0(round(range(clean_data$mmse, na.rm = T)),
      collapse = "-"
    ),
    ")"
  ),
  `**Follow-up time [mean (range)]**` = paste0(
    round(mean(clean_data$FU_time, na.rm = T), digits = 1),
    " (", paste0(round(range(clean_data$FU_time, na.rm = T)),
      collapse = "-"
    ),
    ")"
  ),
  `**Follow-up observations [mean (range)]**` = paste0(
    round(mean(clean_data$FU_obs, na.rm = TRUE), digits = 1),
    " (",
    "2",
    "-",
    round(max(clean_data$FU_obs, na.rm = TRUE)),
    ")"
  )
)

# Bind the total line data frame to the summary statistics table
summary_stats <- bind_rows(summary_stats, total_line)
```

__Table 3__: _Demographic characteristics_

```{r tab3, echo=FALSE}
knitr::kable(summary_stats, align = "c")
```

<small>_Note._ Abbreviations: MMSE Mini Mental State Examination, F female, M male, CI Confidence Interval.</small>

We found that as age increased both memory and hippocampus volume decreased, though we also observed inter-individual differences in these relationships (Supplementary Figure 1). Both the LME model and GAMM fit to this data showed evidence of significant relationships between memory/hippocampus volume and age; however, there was evidence of a non-linear relationship in both models (Supplementary Table 1). We include further details in the supplementary materials.

__**Episodic Memory and Hippocampus Change:**__ 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Helper function to perform regression and extract required statistics
get_regression_stats <- function(formula, data, vars_priority) {
  model <- lm(formula, data = data)
  summary_model <- summary(model)
  coefficients <- summary_model$coefficients

  # Initialize the variable index
  variable_index <- NULL

  # Check for each variable in priority order and break on the first match
  for (var in vars_priority) {
    if (var %in% rownames(coefficients)) {
      variable_index <- which(rownames(coefficients) == var)
      break
    }
  }

  # Check if a relevant variable was found
  if (is.null(variable_index)) {
    stop("None of the priority variables are in the model.")
  }

  coef <- coefficients[variable_index, 1]
  ci <- confint(model)[variable_index, ]
  p_value <- coefficients[variable_index, 4]
  t_stat <- coefficients[variable_index, 3]
  adj_r2 <- summary_model$adj.r.squared
  r2 <- summary_model$r.squared

  return(list(coef = coef, ci = ci, p_value = p_value, t_stat = t_stat, adj_r2 = adj_r2, r2 = r2))
}

# Set a list of priority variables
hc_vars <- c(
  "scale(hc_slopes)",
  "hc_slopes",
  "scale(adj_HIP_total_baseline)",
  "scale(adj_HIP_total_followup)"
)

edu_var <- c(
  "scale(edu)"
)

# Running the regression model
emhp_merged <- get_regression_stats(scale(memory_slopes) ~ scale(hc_slopes) + study + scale(age_baseline) + scale(mem_time) + sex + scale(edu), data = clean_data, hc_vars)
emhp_merged_unscaled <- get_regression_stats(memory_slopes ~ hc_slopes + study + age_baseline + mem_time + sex + edu, data = clean_data, hc_vars)

# Cross-sectional analysis at baseline
model_baseline <- get_regression_stats(scale(memory_baseline) ~ scale(adj_HIP_total_baseline) + study + scale(age_baseline) + scale(edu) + sex, data = clean_data, hc_vars)

# Cross-sectional analysis at follow-up
model_followup <- get_regression_stats(scale(memory_followup) ~ scale(adj_HIP_total_followup) + study + scale(age_followup) + scale(edu), data = clean_data, hc_vars)

# Education and memory
edu_baseline <- get_regression_stats(scale(memory_baseline) ~ study + scale(age_baseline) + scale(edu) + sex, data = clean_data, edu_var)
edu_followup <- get_regression_stats(scale(memory_followup) ~ study + scale(age_followup) + scale(edu), data = clean_data, edu_var)
edu_long <- get_regression_stats(scale(memory_slopes) ~ study + scale(age_baseline) + scale(mem_time) + sex + scale(edu), data = clean_data, edu_var)
```

Hippocampus and memory annual change were significantly correlated (β = `r round(emhp_merged$coef, 3)`, _p_ = `r format_p_value(emhp_merged$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "emhp_merged", "adjusted_p_value"])`, r² = `r round(emhp_merged$r2, 3)`) (Figure 2). Cross-sectionally, hippocampal volume and memory were not significantly correlated at baseline (_p_ = `r format_p_value(model_baseline$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "model_baseline", "adjusted_p_value"])`) but were significantly correlated at follow-up (β = `r round(model_followup$coef, 3)`, _p_ = `r format_p_value(model_followup$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "model_followup", "adjusted_p_value"])`, r² = `r round(model_followup$r2, 3)`). Education was only a significant predictor of memory cross-sectionally at baseline (β = `r round(edu_baseline$coef, 3)`, _p_ = `r format_p_value(edu_baseline$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "edu_baseline", "adjusted_p_value"])`, r² = `r round(edu_baseline$r2, 3)`) and at follow-up (β = `r round(edu_followup$coef, 3)`, _p_ = `r format(format_p_value(edu_followup$p_value), scientific = FALSE)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "edu_followup", "adjusted_p_value"])`, r² = `r round(edu_followup$r2, 3)`) but not longitudinally (_p_ = `r format(format_p_value(edu_long$p_value), scientific = FALSE)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "edu_long", "adjusted_p_value"])`). These results are summarized in Table 4. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# 1) Fit the lm model
lm_mem_hc_study <- lm(memory_slopes ~ hc_slopes + study + age_baseline + mem_time + sex + edu, data = clean_data)

## 2) Create a reference grid over a range of hc_slopes
rg_mem_hc <- ref_grid(
  lm_mem_hc_study,
  at = list(hc_slopes = seq(
    from = min(clean_data$hc_slopes),
    to = max(clean_data$hc_slopes),
    length.out = 50
  )),
  # The next line averages across "study" by default
)

## 3) Get the predicted means for that grid
em_means_mem_hc <- emmeans(rg_mem_hc, ~hc_slopes)
em_df_mem_hc <- as.data.frame(em_means_mem_hc)

## 4) Plot the “average” slope with confidence bands
mem_hc_plot <- ggplot(em_df_mem_hc, aes(x = hc_slopes, y = emmean)) +
  geom_point(
    data = clean_data,
    aes(x = hc_slopes, y = memory_slopes),
    alpha = 0.5
  ) +
  geom_ribbon(
    aes(ymin = lower.CL, ymax = upper.CL),
    fill = "#B4D4FF",
    alpha = 0.2
  ) +
  geom_line(
    size = 1.2,
    color = "#86B6F6"
  ) +
  labs(
    y = "Memory Annual Change",
    x = "Hippocampal Annual Change"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.background = element_rect(fill = "white", color = "white"), # Set background to white
    plot.margin = margin(t = 0.35, r = 0.35, b = 0.35, l = 0.35, unit = "cm"),
    axis.text.x = element_text(margin = margin(t = -5)),
    plot.title = element_text(hjust = 0.5)
  )
```

__Figure 2:__ _Memory vs Hippocampal Annual Change_

```{r fig1, echo=FALSE, dpi = 400, fig.width=6, fig.height=4, message=FALSE, warning=FALSE}
mem_hc_plot
```

The association between memory and hippocampus annual change plotted using a linear model that controls for all covariates using estimated marginal means. The model produces a coefficient of `r format(round(emhp_merged_unscaled$coef, 4), scientific = FALSE)` (scaled: `r round(emhp_merged$coef, 4)`) with confidence intervals. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Create the table
table_data_emhc <- data.frame(
  " " = c(
    "", "**Memory Annual Change**",
    "", "", "**Memory Annual Change**"
  ),
  "**Hippocampus Annual Change**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(emhp_merged$coef, 3), " (", round(emhp_merged$ci[1], 3), " to ", round(emhp_merged$ci[2], 3), ")"),
    "**Education Longitudinal**", "_Coefficient (95% CI)_",
    paste0(round(edu_long$coef, 3), " (", round(edu_long$ci[1], 3), " to ", round(edu_long$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "emhp_merged", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "edu_long", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(emhp_merged$adj_r2, 3),
    "", "_Adjusted R²_", round(edu_long$adj_r2, 3)
  ),
  " " = c(
    "", "**Memory Baseline**",
    "", "", "**Memory Baseline**"
  ),
  "**Hippocampus Baseline**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(model_baseline$coef, 3), " (", round(model_baseline$ci[1], 3), " to ", round(model_baseline$ci[2], 3), ")"),
    "**Education Baseline**", "_Coefficient (95% CI)_",
    paste0(round(edu_baseline$coef, 3), " (", round(edu_baseline$ci[1], 3), " to ", round(edu_baseline$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "model_baseline", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "edu_baseline", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(model_baseline$adj_r2, 3),
    "", "_Adjusted R²_", round(edu_baseline$adj_r2, 3)
  ),
  " " = c(
    "", "**Memory Follow-up**",
    "", "", "**Memory Follow-up**"
  ),
  "**Hippocampus Follow-up**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(model_followup$coef, 3), " (", round(model_followup$ci[1], 3), " to ", round(model_followup$ci[2], 3), ")"),
    "**Education Follow-up**", "_Coefficient (95% CI)_",
    paste0(round(edu_followup$coef, 3), " (", round(edu_followup$ci[1], 3), " to ", round(edu_followup$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "model_followup", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "edu_followup", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(model_followup$adj_r2, 3),
    "", "_Adjusted R²_", round(edu_followup$adj_r2, 3)
  )
)
```

__Table 4__: _Linear Regressions with Hippocampal Annual Change, Education, and Memory Annual Change_

```{r tab4, echo=FALSE} 
# Format and print the table
kable(table_data_emhc, format = "markdown", col.names = c(" ", "**Hippocampus Annual Change**", " ", " ", " ", "**Hippocampus Baseline**", " ", " ", " ", "**Hippocampus Follow-up**", " ", " "))
```
Note. Models are adjusted for age, sex, education, follow-up time, and cohort/MRI scanner. _p_-values are adjusted for multiple comparisons using the FDR. Abbreviations: CI Confidence Interval.

```{r echo=FALSE}
# Calculate the combined CR and BM value
clean_data <- clean_data %>%
  mutate(
    pathway = ifelse(dist_to_cr_line > dist_to_bm_line, "BM Pathway", "CR Pathway"),
  )

# Calculate mean and SD for CR and BM variables
mean_bm <- mean(clean_data$reverse_bm, na.rm = TRUE)
min_bm <- min(clean_data$reverse_bm, na.rm = TRUE)
max_bm <- max(clean_data$reverse_bm, na.rm = TRUE)

mean_cr <- mean(clean_data$reverse_cr, na.rm = TRUE)
min_cr <- min(clean_data$reverse_cr, na.rm = TRUE)
max_cr <- max(clean_data$reverse_cr, na.rm = TRUE)

# Classify participants into CR and BM pathways based on some criteria
# (Replace with actual classification logic if different)

# Divide data into pathways
cr_pathway <- clean_data %>%
  filter(pathway == "CR Pathway") %>%
  nrow()
bm_pathway <- clean_data %>%
  filter(pathway == "BM Pathway") %>%
  nrow()
total_participants <- nrow(clean_data)

# Run analyses for validating the CR variable as a measure of CR
cr_var <- c(
  "scale(hc_slopes):scale(reverse_cr)"
)

bm_var <- c(
  "scale(reverse_bm)"
)

int_var <- c(
  "scale(hc_slopes):factor(pathway)CR Pathway"
)

# Running sensitivity analyses
cr_validation <- get_regression_stats(scale(memory_slopes) ~ scale(hc_slopes) * scale(reverse_cr) + study + scale(age_baseline) + scale(mem_time) + sex + scale(edu), data = clean_data, cr_var)
```

__**Analyzing Cognitive Reserve and Brain Maintenance Variables:**__

We established CR and BM variables as illustrated in Figure 3, which plots each participant’s hippocampal and memory annual change—both adjusted for follow-up age—together with their corresponding CR or BM value. Because these trajectories are adjusted for age, individuals whose hippocampus atrophies and memory declines less than expected for their age appear to show increases in both hippocampal volume and memory. This adjustment for age allows the CR and BM variables to consider the faster rate of decline in hippocampal volume and memory observed among our older participants (Supplementary Figure 1). We found a significant interaction between hippocampal annual change and CR (β = `r round(cr_validation$coef, 3)`, _p_ = `r format_p_value(cr_validation$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_validation", "adjusted_p_value"])`, r² = `r round(cr_validation$r2, 3)`) regressed on memory annual change. 

```{r echo=FALSE, warning=FALSE}
custom_colors_bm <- c("#E5E483", "#8ac926", "#4CCD99", "#5BBCFF", "#024CAA", "#00224D")
custom_colors_cr <- c("#f5d7b0", "#f5be27", "#fa8d00", "#bc507f", "#7E1891", "#1c0159")

cr_plot <- ggplot(clean_data, aes(y = res_mem_slopes_age, x = res_hc_slopes_age, color = (reverse_cr))) +
  geom_point(size = 2, alpha = 0.7) +
  scale_color_gradientn(
    colors = custom_colors_cr,
    limits = c(0.5, 2.85),
    values = c(0, 1 / 3, 2 / 3, 1) # Values mapped to scale so both figures have the same scale
  ) +
  geom_abline(slope = -(abs(max(clean_data$res_mem_slopes_age))) / (abs(min(clean_data$res_hc_slopes_age))), intercept = 0, color = "grey", size = 1, alpha = 0.7) +
  geom_abline(slope = 0, intercept = 0, color = "grey", size = 1, alpha = 0.7) +
  geom_abline(slope = 10000, intercept = 0, color = "grey", size = 1, alpha = 0.7) +
  labs(
    y = "Memory Change (age-adjusted)",
    x = "Hippocampus Change (age-adjusted)",
    color = "Cognitive Reserve",
    tag = "B)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.tag = element_text(size = 12), 
        plot.tag.position = c(0.08, 0.08)) +
  xlim(-400, 300) +
  ylim(-0.6, 0.8)

bm_plot <- ggplot(clean_data, aes(y = res_mem_slopes_age, x = res_hc_slopes_age, color = reverse_bm)) +
  geom_point(size = 2, alpha = 0.7) +
  scale_color_gradientn(
    colors = custom_colors_bm,
    limits = c(0.5, 2.85),
    values = c(0, 1 / 3, 2 / 3, 1) # Values mapped to scale so both figures have the same scale
  ) +
  geom_abline(
    slope = (abs(max(clean_data$res_mem_slopes_age)) / abs(min(clean_data$res_hc_slopes_age))),
    intercept = 0,
    color = "grey",
    size = 1,
    alpha = 0.7
  ) +
  geom_abline(slope = 0, intercept = 0, color = "grey", size = 1, alpha = 0.7) +
  geom_abline(slope = 10000, intercept = 0, color = "grey", size = 1, alpha = 0.7) +
  labs(
    y = "Memory Change (age-adjusted)",
    x = "Hippocampus Change (age-adjusted)",
    color = "Brain Maintenance",
    tag = "A)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.tag = element_text(size = 12), 
        plot.tag.position = c(0.08, 0.08)) +
  xlim(-400, 300) +
  ylim(-0.6, 0.8)

# Combine the plots into one figure
combined_crbm <- bm_plot + cr_plot + plot_layout(ncol = 2)
```

__Figure 3:__ _Brain Maintenance and Cognitive Reserve Plots_

```{r fig2, echo=FALSE, dpi = 400, fig.width=7, fig.height=4, message=FALSE, warning=FALSE}
combined_crbm
```
<small>A) The association between hippocampus and memory annual change, adjusted for follow-up age, depicted with a diagonal line representing the BM line. The color code represents the BM value for a given participant. B) The same association between hippocampus and memory annual change, adjusted for follow-up age, this time depicted with a diagonal line representing the CR line. The color code represents the CR value for a given participant.</small>

We then classified participants as aging CR-like (N = `r cr_pathway`/`r total_participants`) or BM-like (N = `r bm_pathway`/`r total_participants`) based on how closely their hippocampal and memory annual change resembled CR or BM aging patterns (see Methods). Figure 4 distinguishes each individual as aging either CR-like or BM-like, and the color code shows their corresponding CR or BM value, with higher values indicating greater memory stability for their age. The mean BM value for participants aging BM-like was  `r round(mean_bm, 3)` (range = `r round(min_bm, 3)` - `r round(max_bm, 3)`), and the mean CR value for participants aging CR-like was `r round(mean_cr, 3)` (range = `r round(min_cr, 3)` - `r round(max_cr, 3)`). 
```{r echo=FALSE, warning=FALSE}
# Divide data into pathways
cr_path <- clean_data %>%
  filter(pathway == "CR Pathway")

bm_path <- clean_data %>%
  filter(pathway == "BM Pathway")

# Plot the CR half
cr_path_plot <- ggplot(cr_path, aes(pathway, reverse_cr, color = reverse_cr, fill = reverse_cr)) +
  geom_quasirandom(size = 4, alpha = 0.7) +
  scale_color_gradientn(
    colors = c("#f5d7b0", "#f5be27", "#fa8d00", "#bc507f", "#7E1891", "#1c0159"),
    limits = c(0.45, 2.85),
    values = c(0, 1 / 3, 2 / 3, 1) # Values mapped to scale so both figures have the same scale
  ) +
  scale_fill_gradientn(
    colors = c("#f5d7b0", "#f5be27", "#fa8d00", "#bc507f", "#7E1891", "#1c0159"), limits = c(0.55, 2.59),
    values = c(0, 1 / 3, 2 / 3, 1)
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(), # Remove x-axis text
    legend.position = "top",
    axis.title = element_text(size = 13), # Increase font size
    axis.text = element_text(size = 13),
    plot.margin = margin(10, 10, 10, 10)
  ) +
  scale_y_continuous(
    limits = c(0.45, 2.85),
    expand = c(0, 0),
    position = "right" # Move y-axis to the right
  ) +
  labs(
    y = "Cognitive Reserve Value",
    x = "Participants Aging CR-like",
    color = "Cognitive Reserve"
  ) +
  guides(color = "none", fill = guide_colorbar(title = "Cognitive Reserve"))

# Plot the BM half
bm_path_plot <- ggplot(bm_path, aes(pathway, reverse_bm, color = reverse_bm, fill = reverse_bm)) +
  geom_quasirandom(size = 4, alpha = 0.7) +
  scale_color_gradientn(
    colors = c("#E5E483", "#8ac926", "#4CCD99", "#5BBCFF", "#024CAA", "#00224D"),
    limits = c(0.45, 2.85),
    values = c(0, 1 / 3, 2 / 3, 1) # Values mapped to scale so both figures have the same scale
  ) +
  scale_fill_gradientn(
    colors = c("#E5E483", "#8ac926", "#4CCD99", "#5BBCFF", "#024CAA", "#00224D"), limits = c(0.55, 2.59),
    values = c(0, 1 / 3, 2 / 3, 1)
  ) +
  theme_minimal() +
  scale_y_continuous(
    limits = c(0.45, 2.85),
    expand = c(0, 0)
  ) +
  labs(
    y = "Brain Maintenance Value",
    x = "Participants Aging BM-like",
    color = "Brain Maintenance"
  ) +
  theme(
    axis.text.x = element_blank(), # Remove x-axis text
    legend.position = "top",
    axis.title = element_text(size = 13), # Increase font size
    axis.text = element_text(size = 13)
  ) +
  guides(color = "none", fill = guide_colorbar(title = "Brain Maintenance"))

# Add margins
bm_path_plot <- bm_path_plot + theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))
cr_path_plot <- cr_path_plot + theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

# Combine the halves
index_plot <- bm_path_plot + cr_path_plot + plot_layout(ncol = 2, widths = c(1, 1))
```

__Figure 4:__ _Brain Maintenance and Cognitive Reserve Pathways_

```{r fig3, echo=FALSE, dpi = 400, fig.width=8, fig.height=4, message=FALSE, warning=FALSE}
index_plot
```

An illustration that classifies each participant as aging either BM-like (left panel) or CR-like (right panel). The vertical axis indicates the BM or CR value, which is derived from each individual’s proximity to an ideal BM or CR pattern of hippocampal and memory annual change (see Methods and Figure 1 for details). The color gradient reflects the BM or CR value within each subgroup. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Prep the data for visualization

# Create groups of high and low
cr_path$reverse_cr_group <- cut(cr_path$reverse_cr,
  breaks = quantile(cr_path$reverse_cr, probs = seq(0, 1, (1 / 2)), na.rm = TRUE),
  include.lowest = TRUE,
  labels = c("Low CR", "High CR")
)

# And for BM
bm_path$reverse_bm_group <- cut(bm_path$reverse_bm,
  breaks = quantile(bm_path$reverse_bm, probs = seq(0, 1, (1 / 2)), na.rm = TRUE),
  include.lowest = TRUE,
  labels = c("Low BM", "High BM")
)

# Convert df to long
long_data_vis_cr <- cr_path %>%
  pivot_longer(
    cols = matches("^memory\\.\\d$|^age\\.\\d$|^adj_HIP_total\\.\\d$"),
    names_to = c(".value", "timepoint"),
    names_pattern = "(.*)(\\d$)"
  )

long_data_vis_bm <- bm_path %>%
  pivot_longer(
    cols = matches("^memory\\.\\d$|^age\\.\\d$|^adj_HIP_total\\.\\d$"),
    names_to = c(".value", "timepoint"),
    names_pattern = "(.*)(\\d$)"
  )

long_data_vis_cr <- long_data_vis_cr %>%
  rename(
    age = "age.",
    adj_HIP_total = "adj_HIP_total.",
    memory = "memory."
  ) %>%
  filter(!is.na(age) & !is.na(memory))

long_data_vis_bm <- long_data_vis_bm %>%
  rename(
    age = "age.",
    adj_HIP_total = "adj_HIP_total.",
    memory = "memory."
  ) %>%
  filter(!is.na(age) & !is.na(memory))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Education and CR
vars <- c(
  "scale(reverse_cr)"
)

int_vars <- c(
  "scale(reverse_cr):scale(edu)"
)

edu_cr <- get_regression_stats(scale(edu) ~ scale(reverse_cr) + study, data = clean_data, vars)

edu_cr_int <- get_regression_stats(scale(memory_slopes) ~ scale(reverse_cr) * scale(edu) + study, data = clean_data, int_vars)
```

__**Cognitive Reserve Associations with Education and Functional Connectivity:**__

There were no significant relationships between CR (_p_ = `r format_p_value(edu_cr$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "edu_cr", "adjusted_p_value"])`) and education, nor was there a significant interaction between CR and education regressed on memory annual change (_p_ = `r format_p_value(edu_cr_int$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "edu_cr_int", "adjusted_p_value"])`; Table 5). 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Create a CR & education table
edu_table_data <- data.frame(
  " " = c(
    "", "**Education**"
  ),
  "**Cognitive Reserve**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(edu_cr$coef, 3), " (", round(edu_cr$ci[1], 3), " to ", round(edu_cr$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_",
    format_p_value(p_value_df[p_value_df$model_name == "edu_cr", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_",
    round(edu_cr$adj_r2, 3)
  ),
  " " = c(
    "",
    "**Memory Annual Change**"
  ),
  "**Cognitive Reserve * Education**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(edu_cr_int$coef, 3), " (", round(edu_cr_int$ci[1], 3), " to ", round(edu_cr_int$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_",
    format_p_value(p_value_df[p_value_df$model_name == "edu_cr_int", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_",
    round(edu_cr_int$adj_r2, 3)
  )
)
```

__Table 5__: _Linear Regressions with Cognitive Reserve and Education_

```{r tab6, echo=FALSE} 
# Format and print the table
kable(edu_table_data, format = "markdown", col.names = c(" ", "**Cognitive Reserve**", " ", " ", " ", "**Cognitive Reserve * Education**", " ", " "))
```

Note. Models are adjusted for cohort/MRI scanner. _p_-values are adjusted for multiple comparisons using the FDR. Abbreviations: CI Confidence Interval.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Memory and function connectivity regs for CR

# Set the priority variables
priority_var_cr <- c(
  "scale(reverse_cr)"
)

priority_var_int_cr <- c(
  "scale(reverse_cr):scale(dmn_slopes)",
  "scale(reverse_cr):scale(ec_slopes)",
  "scale(reverse_cr):scale(sn_slopes)",
  "scale(reverse_cr):scale(dmn_baseline)",
  "scale(reverse_cr):scale(ec_baseline)",
  "scale(reverse_cr):scale(sn_baseline)",
  "scale(reverse_cr):scale(dmn_followup)",
  "scale(reverse_cr):scale(ec_followup)",
  "scale(reverse_cr):scale(sn_followup)"
)

cr_dmn_stats <- get_regression_stats(scale(dmn_slopes) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_dmn <- get_regression_stats(scale(memory_slopes) ~ scale(reverse_cr) * scale(dmn_slopes) + study, data = clean_data, priority_var_int_cr)

cr_ecn_stats <- get_regression_stats(scale(ec_slopes) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_ec <- get_regression_stats(scale(memory_slopes) ~ scale(reverse_cr) * scale(ec_slopes) + study, data = clean_data, priority_var_int_cr)

cr_sn_stats <- get_regression_stats(scale(sn_slopes) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_sn <- get_regression_stats(scale(memory_slopes) ~ scale(reverse_cr) * scale(sn_slopes) + study, data = clean_data, priority_var_int_cr)

# Cross-sectional analyses
cr_dmn_stats_bl <- get_regression_stats(scale(dmn_baseline) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_dmn_stats_fu <- get_regression_stats(scale(dmn_followup) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_dmn_bl <- get_regression_stats(scale(memory_baseline) ~ scale(reverse_cr) * scale(dmn_baseline) + study, data = clean_data, priority_var_int_cr)
cr_dmn_fu <- get_regression_stats(scale(memory_followup) ~ scale(reverse_cr) * scale(dmn_baseline) + study, data = clean_data, priority_var_int_cr)

cr_ecn_stats_bl <- get_regression_stats(scale(ec_baseline) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_ecn_stats_fu <- get_regression_stats(scale(ec_followup) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_ec_bl <- get_regression_stats(scale(memory_baseline) ~ scale(reverse_cr) * scale(ec_baseline) + study, data = clean_data, priority_var_int_cr)
cr_ec_fu <- get_regression_stats(scale(memory_followup) ~ scale(reverse_cr) * scale(ec_baseline) + study, data = clean_data, priority_var_int_cr)

cr_sn_stats_bl <- get_regression_stats(scale(sn_baseline) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_sn_stats_fu <- get_regression_stats(scale(sn_followup) ~ scale(reverse_cr) + study, data = clean_data, priority_var_cr)
cr_sn_bl <- get_regression_stats(scale(memory_baseline) ~ scale(reverse_cr) * scale(sn_baseline) + study, data = clean_data, priority_var_int_cr)
cr_sn_fu <- get_regression_stats(scale(memory_followup) ~ scale(reverse_cr) * scale(sn_baseline) + study, data = clean_data, priority_var_int_cr)
```

With functional connectivity, there was no evidence of a significant association between CR and anterior SN annual change (_p_ = `r format_p_value(cr_sn_stats$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_sn_stats", "adjusted_p_value"])`). A marginal effect of CR on DMN (_p_ = `r format_p_value(cr_dmn_stats$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_stats", "adjusted_p_value"])`) and ECN annual change (_p_ = `r format_p_value(cr_ecn_stats$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_ecn_stats", "adjusted_p_value"])`) did not survive correction for multiple comparisons. There was limited evidence of a significant interaction between CR and DMN annual change regressed on memory annual change; however, this did not survive correction for multiple comparisons (_p_ = `r format_p_value(cr_dmn$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_dmn", "adjusted_p_value"])`). There was a significant interaction between CR and both ECN (β = `r round(cr_ec$coef, 3)`, _p_ = `r format(format_p_value(cr_ec$p_value), scientific = FALSE)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_ec", "adjusted_p_value"])`, r² = `r round(cr_ec$r2, 3)`) and anterior SN annual change (β = `r round(cr_sn$coef, 3)`, _p_ = `r format_p_value(cr_sn$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_sn", "adjusted_p_value"])`, r² = `r round(cr_sn$r2, 3)`) regressed on memory annual change. Figure 5 depicts the relationship between memory annual change and anterior SN annual change (panel A) or ECN annual change (panel B), with each panel dividing individuals into high, mid, or low CR subgroups. All longitudinal functional connectivity results are summarized in Table 6. Cross-sectionally, there were no significant associations between CR and functional connectivity (Supplementary Table 2).

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Divide the continuous variable into groups to be able to better visualize the data
clean_data$reverse_cr_group <- cut(clean_data$reverse_cr,
  breaks = quantile(clean_data$reverse_cr, probs = seq(0, 1, (1 / 3)), na.rm = TRUE),
  include.lowest = TRUE,
  labels = c("Low CR", "Mid CR", "High CR")
)

# Set the reference study
clean_data$study <- relevel(factor(clean_data$study), ref = "cobra")

# Run the model to control for study
fit_int_ec <- lm(
  memory_slopes ~ ec_slopes * reverse_cr + study,
  data = clean_data
)

# Generate the predictions
pred_int_ec <- ggpredict(
  fit_int_ec,
  terms = c("ec_slopes [all]", "reverse_cr [meansd]"),
  type = "fixed"
)

# Rename the variables in the predictions df
pred_int_ec <- pred_int_ec %>%
  rename(
    ec_slopes         = x,
    memory_slopes     = predicted,
    conf_low          = conf.low,
    conf_high         = conf.high,
    reverse_cr_group  = group
  )

# Create the ECN plot
ec_int <- ggplot() +
  geom_point(
    data = clean_data,
    aes(
      x = ec_slopes, y = memory_slopes,
      color = reverse_cr_group
    ),
    alpha = 0.5,
    show.legend = FALSE
  ) +
  scale_color_manual(values = c(
    "Low CR" = "#F0A048",
    "Mid CR" = "lightgrey",
    "High CR" = "#580678"
  )) +
  new_scale_color() +
  geom_line(
    data = pred_int_ec,
    aes(
      x = ec_slopes, y = memory_slopes,
      color = reverse_cr_group,
      group = reverse_cr_group
    ),
    size = 1
  ) + # Explicitly set the size of the line
  geom_ribbon(
    data = pred_int_ec,
    aes(
      x = ec_slopes, ymin = conf_low, ymax = conf_high,
      fill = reverse_cr_group,
      group = reverse_cr_group
    ),
    alpha = 0.2
  ) +
  scale_color_manual(
    values = c(
      "1.65" = "#F0A048",
      "1.86" = "lightgrey",
      "2.06" = "#580678"
    ),
    name = "Group",
    labels = c("1.65" = "Low CR", "1.86" = "Mid CR", "2.06" = "High CR")
  ) +
  scale_fill_manual(
    values = c(
      "1.65" = "#F0A048",
      "1.86" = "lightgrey",
      "2.06" = "#580678"
    ),
    name = "Group",
    labels = c("1.65" = "Low CR", "1.86" = "Mid CR", "2.06" = "High CR")
  ) +
  labs(
    x = "ECN Slopes",
    y = "Memory Annual Change",
    color = "Group",
    fill = "Group",
    tag = "B)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom", # Move legend to the bottom
    plot.title = element_text(hjust = 0.5),
    plot.tag = element_text(size = 12), 
    plot.tag.position = c(0.08, 0.055)
  )

# Run the regression for SN
fit_int_sn <- lm(
  memory_slopes ~ sn_slopes * reverse_cr + study,
  data = clean_data
)

# Generate the predictions
pred_int_sn <- ggpredict(
  fit_int_sn,
  terms = c("sn_slopes [all]", "reverse_cr [meansd]"),
  type = "fixed"
)

# Rename the variables
pred_int_sn <- pred_int_sn %>%
  rename(
    sn_slopes         = x,
    memory_slopes     = predicted,
    conf_low          = conf.low,
    conf_high         = conf.high,
    reverse_cr_group  = group
  )

# Plot the SN data
sn_int <- ggplot() +
  geom_point(
    data = clean_data,
    aes(
      x = sn_slopes, y = memory_slopes,
      color = reverse_cr_group
    ),
    alpha = 0.5,
    show.legend = FALSE
  ) +
  scale_color_manual(values = c(
    "Low CR" = "#F0A048",
    "Mid CR" = "lightgrey",
    "High CR" = "#580678"
  )) +
  new_scale_color() +
  geom_line(
    data = pred_int_sn,
    aes(
      x = sn_slopes, y = memory_slopes,
      color = reverse_cr_group,
      group = reverse_cr_group
    ),
    size = 1
  ) + # Explicitly set the size of the line
  geom_ribbon(
    data = pred_int_sn,
    aes(
      x = sn_slopes, ymin = conf_low, ymax = conf_high,
      fill = reverse_cr_group,
      group = reverse_cr_group
    ),
    alpha = 0.2
  ) +
  scale_color_manual(
    values = c(
      "1.65" = "#F0A048",
      "1.86" = "lightgrey",
      "2.06" = "#580678"
    ),
    name = "Group",
    labels = c("1.65" = "Low CR", "1.86" = "Mid CR", "2.06" = "High CR")
  ) +
  scale_fill_manual(
    values = c(
      "1.65" = "#F0A048",
      "1.86" = "lightgrey",
      "2.06" = "#580678"
    ),
    name = "Group",
    labels = c("1.65" = "Low CR", "1.86" = "Mid CR", "2.06" = "High CR")
  ) +
  labs(
    x = "Anterior SN Slopes",
    y = "Memory Annual Change",
    color = "Group",
    fill = "Group",
    tag = "A)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom", # Move legend to the bottom
    plot.title = element_text(hjust = 0.5),
    plot.tag = element_text(size = 12), 
    plot.tag.position = c(0.08, 0.055)
  ) +
  scale_x_continuous(breaks = seq(-0.1, 0.15, by = 0.05))

# Combine the two plots
combined_plot <- sn_int + ec_int
```

__Figure 5:__ _The Interaction Between Cognitive Reserve, Functional Connectivity Change, and Memory Change_

```{r fig5, echo=FALSE, dpi = 400, fig.width=7, fig.height=4, message=FALSE, warning=FALSE}
combined_plot
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
coeffs_by_group_ec <- pred_int_ec %>%
  group_by(reverse_cr_group) %>%
  do({
    # Fit a simple linear regression of the plotted line within each CR group
    mod <- lm(memory_slopes ~ ec_slopes, data = .)
    # Extract slope and CIs
    data.frame(tidy(mod, conf.int = TRUE))
  }) %>%
  # Keep only the slope row
  filter(term == "ec_slopes")

# Extract coefficients for ECN each group
high_cr_coeff_ec <- coeffs_by_group_ec %>% filter(reverse_cr_group == "2.06")
mid_cr_coeff_ec <- coeffs_by_group_ec %>% filter(reverse_cr_group == "1.86")
low_cr_coeff_ec <- coeffs_by_group_ec %>% filter(reverse_cr_group == "1.65")

# Repeat for SN
coeffs_by_group_sn <- pred_int_sn %>%
  group_by(reverse_cr_group) %>%
  do({
    mod <- lm(memory_slopes ~ sn_slopes, data = .)
    data.frame(tidy(mod, conf.int = TRUE))
  }) %>%
  filter(term == "sn_slopes")

high_cr_coeff_sn <- coeffs_by_group_sn %>% filter(reverse_cr_group == "2.06")
mid_cr_coeff_sn <- coeffs_by_group_sn %>% filter(reverse_cr_group == "1.86")
low_cr_coeff_sn <- coeffs_by_group_sn %>% filter(reverse_cr_group == "1.65")
```

<small>A) The association between anterior SN and memory annual change, adjusted for cohort/MRI scanner,  shown for three groups of CR (high=purple, mid=grey, low=orange). The lines (with confidence intervals) represent predicted values derived from a fitted regression model, with high CR representing one standard deviation above the mean, mid CR representing the mean, and low CR representing one standard deviation below the mean. This results in group‐specific slopes of `r round(high_cr_coeff_sn$estimate, 3)` for high CR, `r round(mid_cr_coeff_sn$estimate, 3)` for mid CR, and `r round(low_cr_coeff_sn$estimate, 3)` for low CR. The lower panel highlights the anterior SN as defined in the Shirer atlas. B) The association between ECN and memory annual change, similarly adjusted and plotted with predicted values, shown for the same three groups, with slopes of `r round(high_cr_coeff_ec$estimate, 3)` for high CR, `r round(mid_cr_coeff_ec$estimate, 3)` for mid CR, and `r round(low_cr_coeff_ec$estimate, 3)` for low CR, with the ECN highlighted in the lower panel. Abbreviations: ECN Executive Control Network, SN Salience Network, CR Cognitive Reserve, BM Brain Maintenance.</small>

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Create the table
long_fc <- data.frame(
  " " = c(
    "", "**Cognitive Reserve**",
    "", "", "**Memory Annual Change**"
  ),
  "**DMN Baseline**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(cr_dmn_stats$coef, 3), " (", round(cr_dmn_stats$ci[1], 3), " to ", round(cr_dmn_stats$ci[2], 3), ")"),
    "**DMN Annual Change * Cognitive Reserve**", "_Coefficient (95% CI)_",
    paste0(round(cr_dmn$coef, 3), " (", round(cr_dmn$ci[1], 3), " to ", round(cr_dmn$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_stats", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_dmn", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(cr_dmn_stats$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_dmn$adj_r2, 3)
  ),
  "**ECN Annual Change**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(cr_ecn_stats$coef, 3), " (", round(cr_ecn_stats$ci[1], 3), " to ", round(cr_ecn_stats$ci[2], 3), ")"),
    "**ECN Annual Change * Cognitive Reserve **", "_Coefficient (95% CI)_",
    paste0(round(cr_ec$coef, 3), " (", round(cr_ec$ci[1], 3), " to ", round(cr_ec$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_ecn_stats", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_ec", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(cr_ecn_stats$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_ec$adj_r2, 3)
  ),
  "**Anterior SN Annual Change**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(cr_sn_stats$coef, 3), " (", round(cr_sn_stats$ci[1], 3), " to ", round(cr_sn_stats$ci[2], 3), ")"),
    "**Anterior SN Annual Change * Cognitive Reserve**", "_Coefficient (95% CI)_",
    paste0(round(cr_sn$coef, 3), " (", round(cr_sn$ci[1], 3), " to ", round(cr_sn$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_sn_stats", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_sn", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(cr_sn_stats$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_sn$adj_r2, 3)
  )
)
```

__Table 6__: _Linear Regressions with Cognitive Reserve and Functional Connectivity_
```{r tab7, echo=FALSE} 
# Format and print the table
kable(long_fc, format = "markdown", col.names = c(" ", "**DMN Annual Change**", " ", " ", "**ECN Annual Change**", " ", " ", "**Anterior SN Annual Change**", " ", " "))
```

Note. Models are adjusted for cohort/MRI scanner. _p_-values are adjusted for multiple comparisons using the FDR. Abbreviations: DMN Default Mode Network, ECN Executive Control Network, SN Salience Network, CI Confidence Interval.

**Supplementary Materials**

**_Linear Mixed Effects and Generalized Additive Mixed Models for Memory, Hippocampus Volume, and Age_**
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Convert df to long format
long_clean_data <- clean_data %>%
  pivot_longer(
    cols = matches("^memory\\.\\d$|^age\\.\\d$|^adj_HIP_total\\.\\d$"),
    names_to = c(".value", "timepoint"),
    names_pattern = "(.*)(\\d$)"
  )

long_clean_data <- long_clean_data %>%
  rename(
    age = "age.",
    adj_HIP_total = "adj_HIP_total.",
    memory = "memory."
  )

# Add a function for getting the stats from LME models
get_mixed_effects_stats <- function(formula, data, vars_priority) {
  # Fit the mixed-effects model
  model <- lmer(formula, data = data)
  summary_model <- summary(model)
  coefficients <- summary_model$coefficients
  anova_results <- anova(model) # Get ANOVA results for p-values

  # Initialize the variable index
  variable_index <- NULL

  # Check for each variable in priority order and break on the first match
  for (var in vars_priority) {
    if (var %in% rownames(coefficients)) {
      variable_index <- which(rownames(coefficients) == var)
      break
    }
  }

  # Check if a relevant variable was found
  if (is.null(variable_index)) {
    stop("None of the priority variables are in the model.")
  }

  coef <- coefficients[variable_index, 1]
  ci <- confint(model, parm = rownames(coefficients)[variable_index])

  # Extract p-value from ANOVA table
  p_value <- anova_results[which(rownames(anova_results) == rownames(coefficients)[variable_index]), "Pr(>F)"]
  r2 <- as.data.frame(VarCorr(model))$vcov[1]

  return(list(coef = coef, ci = ci, p_value = p_value, r2 = r2))
}

# Set a list of priority variables
vars <- c(
  "scale(age):scale(reverse_cr)",
  "scale(age):scale(reverse_bm)"
)

# Linear model for comparison with the gam model
mod_lme_mem <- lmer(memory ~ age + (1 | id) + study, data = long_clean_data)
aic_lm_mem <- AIC(mod_lme_mem)
bic_lm_mem <- BIC(mod_lme_mem)

mod_lme_hc <- lmer(adj_HIP_total ~ age + (1 | id) + study, data = long_clean_data)
aic_lm_hc <- AIC(mod_lme_hc)
bic_lm_hc <- BIC(mod_lme_hc)

# Get the regression stats
age <- c("scale(age)")

suppressMessages({
  mem_age_lme <- get_mixed_effects_stats(scale(memory) ~ scale(age) + (1 | id) + study, data = long_clean_data, age)
  hc_age_lme <- get_mixed_effects_stats(scale(adj_HIP_total) ~ scale(age) + (1 | id) + study, data = long_clean_data, age)
})
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Uncomment this code to evaluate and check GAMM assumptions

# # Loop through k values and print results
# for (k in 1:27) {
#   model_mem <- gamm4(memory ~ s(age, k = k+3) + study, data = long_clean_data, random = ~(1|id))
#
#   cat("Model with k =", k + 3, "\n")
#   cat("AIC:", AIC(model_mem$mer), "\n")
#   cat("BIC:", BIC(model_mem$mer), "\n")
#   cat("LogLik:", logLik(model_mem$mer), "\n")
#   cat("\n")
# }
#
# # Loop through k values and print results
# for (k in 1:27) {
#   model_hc <- gamm4(adj_HIP_total ~ s(age, k = k+3) + study, data = long_clean_data, random = ~(1|id))
#
#   cat("Model with k =", k + 3, "\n")
#   cat("AIC:", AIC(model_hc$mer), "\n")
#   cat("BIC:", BIC(model_hc$mer), "\n")
#   cat("LogLik:", logLik(model_hc$mer), "\n")
#   cat("\n")
# }
#
# gamm_memory <- gamm4(memory ~ s(age, k = 4) + study, data = long_clean_data, random = ~(1|id))
# gam.check(gamm_memory$gam)
#
# gamm_hc <- gamm4(adj_HIP_total ~ s(age, k = 5) + study, data = long_clean_data, random = ~(1|id))
# gam.check(gamm_hc$gam)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Function to calculate and store gamm model metrics
get_gamm_metrics <- function(k, df, response_var, lme_mod) {
  max_k <- min(k, length(unique(df$age)) - 1)

  if (max_k > 1) {
    # Dynamically use the response variable and correct random effect
    mod_em <- gamm4(as.formula(paste(response_var, "~ 1 + s(age, k =", max_k, ") +", make.names("study"))),
      data = df, random = ~ (1 | id)
    )

    # Calculate required metrics
    aic <- AIC(mod_em$mer)
    bic <- BIC(mod_em$mer)
    loglik <- logLik(mod_em$mer)

    # Extract EDF
    edf <- sum(summary(mod_em$gam)$edf)

    # Calculate p-value for the GAMM terms
    gamm_summary <- summary(mod_em$gam)
    p_value_gamm <- gamm_summary$s.pv

    # Likelihood ratio test
    lrt_stat <- -2 * (logLik(lme_mod) - loglik) # Comparing the lme to the gamm model
    lrt_df <- df.residual(lme_mod) - df.residual(mod_em$mer)
    p_value_lrt <- 1 - pchisq(lrt_stat, lrt_df)

    # Return a named list of metrics
    return(data.frame(
      k = max_k, AIC = aic, BIC = bic, LogLik = loglik,
      EDF = edf, LRT_df = lrt_df, "LRT test stat" = lrt_stat,
      "p_value_gamm" = as.numeric(p_value_gamm),
      "p_value_lrt" = as.numeric(p_value_lrt)
    ))
  } else {
    return(data.frame(
      k = max_k, AIC = NA, BIC = NA,
      LogLik = NA, EDF = NA, "LRT test stat" = NA,
      "p_value_gamm" = NA, "p_value_lrt" = NA
    ))
  }
}

# Function to fit and compare models over k range for different response variables
gamm_compare <- function(response_var, mod_lme) {
  compare_gamm <- do.call(rbind, lapply(k_range, function(k) {
    get_gamm_metrics(k, long_clean_data, response_var, mod_lme)
  }))
  return(compare_gamm)
}

# Run the comparison for memory and adjusted HIP
k_range <- 4 # Define k range for memory
gamm_compare_em_memory <- gamm_compare("memory", mod_lme_mem)

k_range <- 5 # Define k range for HC
gamm_compare_em_adj_hc <- gamm_compare("adj_HIP_total", mod_lme_hc)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
gamm_table <- data.frame(
  " " = c(
    "",
    "**GAMM**",
    "**LME Model**"
  ),
  "**Memory**" = c(
    "_AIC_",
    paste0(round(gamm_compare_em_memory$AIC, 3)),
    paste0(round(aic_lm_mem, 3))
  ),
  " " = c(
    "_BIC_",
    paste0(round(gamm_compare_em_memory$BIC, 3)),
    paste0(round(bic_lm_mem, 3))
  ),
  " " = c(
    "_Adjusted LRT p-value_",
    format_p_value(p_value_df[p_value_df$model_name == "gamm_memory_lft", "adjusted_p_value"]),
    " "
  ),
  "**Hippocampus Volume**" = c(
    "_AIC_",
    paste0(round(gamm_compare_em_adj_hc$AIC, 3)),
    paste0(round(aic_lm_hc, 3))
  ),
  " " = c(
    "_BIC_",
    paste0(round(gamm_compare_em_adj_hc$BIC, 3)),
    paste0(round(bic_lm_hc, 3))
  ),
  " " = c(
    "_Adjusted LRT p-value_",
    format_p_value(p_value_df[p_value_df$model_name == "gamm_hc_lft", "adjusted_p_value"]),
    " "
  )
)
```

We initially fit the GAMMs using a range of basis functions and compared their fit to the LME model. Despite variations in the GAMM fits, the conclusions regarding how the GAMM and the LME models compared did not change. In Supplementary Table 1, we fit the GAMMs with four basis functions for the memory model and five basis functions for the hippocampus model as increasing the number beyond this point did not substantially change the AIC nor BIC values. The smooth age-term was significant in the memory GAMM (effective degrees of freedom (EDF) = `r round(gamm_compare_em_memory$EDF, 3)`, _p_-value = `r format_p_value(gamm_compare_em_memory$p_value_gamm)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "gamm_memory_gamm", "adjusted_p_value"])`) and the hippocampus GAMM (EDF = `r round(gamm_compare_em_adj_hc$EDF, 3)`, _p_-value = `r format_p_value(gamm_compare_em_adj_hc$p_value_gamm)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "gamm_hc_gamm", "adjusted_p_value"])`. For the LME models, both models had significant age coefficients (memory: β = `r round(mem_age_lme$coef, 3)`, _p_ = `r format(format_p_value(mem_age_lme$p_value), scientific = FALSE)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "mem_age_lme", "adjusted_p_value"])`; hippocampal volume β = `r round(hc_age_lme$coef, 3)`, _p_ = `r format(format_p_value(hc_age_lme$p_value), scientific = FALSE)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "hc_age_lme", "adjusted_p_value"])`). For memory, the LME and GAMM fits were similar; however, the GAMM fit was better according to AIC and LRT. For hippocampal volume, the GAMM fit was better according to AIC, BIC, and LRT.

__Supplementary Table 1__: _Linear Mixed Effects and Generalized Additive Mixed Models_
```{r suptab1, echo=FALSE} 
# Format and print the table
kable(gamm_table, format = "markdown", col.names = c(" ", "**Memory**", " ", " ", "**Hippocampus**", " ", " "))
```
Note. Models are adjusted for cohort/MRI scanner. _p_-values are adjusted for multiple comparisons using the FDR. Abbreviations: GAMM Generalized Additive Mixed Model, LME Linear Mixed Effects, AIC Akaike Information Criterion, BIC Bayesian Information Criterion, LRT Likelihood Ratio Test.

__Supplementary Figure 1__: _Memory and Hippocampus Volume Change with Age_
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract residuals
long_clean_data <- long_clean_data %>%
  filter(!is.na(age) & !is.na(memory) & !is.na(adj_HIP_total))

residual_model_age <- lm(age ~ study, data = long_clean_data)
residual_model_mem <- lm(memory ~ study, data = long_clean_data)
residual_model_hc <- lm(adj_HIP_total ~ study, data = long_clean_data)
long_clean_data$res_age <- residuals(residual_model_age)
long_clean_data$res_mem <- residuals(residual_model_mem)
long_clean_data$res_hc <- residuals(residual_model_hc)

# Define colors
color_palette <- c("indianred2", "steelblue2", "#86db49", "#F7CA18", "blue", "black")

# Create the plot age v memory
mem_age <- ggplot(long_clean_data, aes(x = age, y = memory, color = Study, group = id)) +
  geom_line(size = 0.4) +
  geom_point(size = 0.6) +
  scale_color_manual(values = color_palette) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 24, bs = "cs"), aes(group = 1), color = "grey", se = TRUE) +
  labs(x = "Age", y = "Episodic Memory", color = "Cohort", tag = "A)") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.tag = element_text(size = 11), 
        plot.tag.position = c(0, 1))

# Create the plot age v HC
hc_age <- ggplot(long_clean_data, aes(x = age, y = adj_HIP_total, color = Study, group = id)) +
  geom_line(size = 0.4) +
  geom_point(size = 0.6) +
  scale_color_manual(values = color_palette) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 24, bs = "cs"), aes(group = 1), color = "grey", se = TRUE) +
  labs(x = "Age", y = "Hippocampal Volume", color = "Cohort", tag = "B)") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.tag = element_text(size = 11), 
        plot.tag.position = c(0, 1)) # Remove legend for the second plot

# Combine the plots and collect legend
hc_mem_age <- mem_age + hc_age + plot_layout(ncol = 2, guides = "collect") &
  theme(legend.position = "bottom")
```

```{r supfig1, echo=FALSE, dpi = 400, fig.width=7, fig.height=4, message=FALSE, warning=FALSE}
hc_mem_age
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
vars_unscale <- c(
  "age"
)

mem_age_unscaled <- get_mixed_effects_stats((memory) ~ age + (1 | id) + study, data = long_clean_data, vars_unscale)
```
<small>A) The association between memory and age with individual trajectories and a generalized additive mixed model (EDF = `r round(gamm_compare_em_memory$EDF, 3)`) and confidence intervals. B) The association between hippocampal volume and age with individual trajectories with a generalized additive mixed model (EDF = `r round(gamm_compare_em_adj_hc$EDF, 3)`) and confidence intervals. Abbreviations: EDF effective degrees of freedom.</small>

**_Cognitive Reserve’s and Brain Maintenance’s Relationship with Memory and Age_**

```{r echo=FALSE, message=FALSE, warning=FALSE}
cr_age_lme <- get_mixed_effects_stats(
  scale(memory) ~ scale(age) * scale(reverse_cr) + study + scale(age_baseline) +
    scale(mem_time) + sex + scale(edu) + (1 | id),
  long_data_vis_cr,
  vars
)

bm_age_lme <- get_mixed_effects_stats(
  scale(memory) ~ scale(age) * scale(reverse_bm) + study + scale(age_baseline) +
    scale(mem_time) + sex + scale(edu) + (1 | id),
  long_data_vis_bm,
  vars
)
```

Though we observed inter-individual differences, for participants aging CR-like, we found a significant interaction between CR and age (β = `r round(cr_age_lme$coef, 3)`, _p_ = `r format_p_value(cr_age_lme$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_age_lme", "adjusted_p_value"])`, r² = `r round(cr_age_lme$r2, 3)`) and, for participants aging BM-like, a significant interaction between BM and age (β = `r round(bm_age_lme$coef, 3)`, _p_ = `r format_p_value(bm_age_lme$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "bm_age_lme", "adjusted_p_value"])`, r² = `r round(bm_age_lme$r2, 3)`) on memory. Supplementary Figure 2 illustrates the relationship between memory and age for participants aging BM-like (panel A) or CR-like (panel B), with each panel splitting individuals into high or low BM/CR subgroups.

Note. Models are adjusted for age, sex, education, follow-up time, and cohort/MRI scanner. _p_-values are adjusted for multiple comparisons using the FDR. Abbreviations: CI Confidence Interval.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Fit the mixed-effects model
model_res_lme_cr <- lmer(memory ~ age * reverse_cr_group + (1 | id) + study + age_baseline + mem_time + sex + edu, data = long_data_vis_cr)

# Define a range of ages for prediction
age_seq <- seq(min(long_data_vis_cr$age), max(long_data_vis_cr$age), length.out = 100)

# Generate predictions for each CR group
# Divides the low and high CR groups into 100 age bands and,
# using the LME model from above, predicts their memory for each of the age bands
em_2group <- emmeans(
  model_res_lme_cr,
  specs = ~ age * reverse_cr_group,
  at    = list(age = age_seq),
  reff  = 0
)

# Convert the emmeans results to a data frame and rename columns
predictions <- summary(em_2group) %>%
  as.data.frame() %>%
  rename(
    predicted   = emmean,
    lower_bound = lower.CL,
    upper_bound = upper.CL
  ) %>%
  mutate(age = as.numeric(age))

# Define colors for each CR group
palette <- c("High CR" = "#580678", "Low CR" = "#F0A048")

# Create the plot
cr_age_plot <- ggplot() +
  geom_line(data = long_data_vis_cr, aes(x = age, y = memory, group = id), color = "lightgray", alpha = 0.5) + # Plot individual trajectories
  geom_point(data = long_data_vis_cr, aes(x = age, y = memory), color = "gray", size = 1, alpha = 0.8) + # Add scatter points
  geom_ribbon(data = predictions, aes(x = age, ymin = lower_bound, ymax = upper_bound, fill = as.factor(reverse_cr_group)), alpha = 0.3) + # Add CIs
  geom_line(data = predictions, aes(x = age, y = predicted, color = as.factor(reverse_cr_group)), size = 1.2) + # Plot predicted lines for each group
  scale_color_manual(values = palette) +
  scale_fill_manual(values = palette) + # Ensure fill colors match line colors
  labs(
    x = "Age", 
    y = "Memory", 
    color = "Group", 
    fill = "Group", 
    title = "Participants Aging CR-like",
    tag = "B)") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.tag = element_text(size = 12), 
        plot.tag.position = c(0.08, 0.055))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Fit the mixed-effects model
model_res_lme_bm <- lmer(memory ~ age * reverse_bm_group + (1 | id) + study + age_baseline + mem_time + sex + edu, data = long_data_vis_bm)

# Define a range of ages for prediction
age_seq <- seq(min(long_data_vis_bm$age), max(long_data_vis_bm$age), length.out = 100)

# Generate predictions for each BM group
em_2group <- emmeans(
  model_res_lme_bm,
  specs = ~ age * reverse_bm_group,
  at    = list(age = age_seq),
  reff  = 0
)

# Convert the emmeans results to a data frame and rename columns
predictions <- summary(em_2group) %>%
  as.data.frame() %>%
  rename(
    predicted   = emmean,
    lower_bound = lower.CL,
    upper_bound = upper.CL
  ) %>%
  mutate(age = as.numeric(age))

# Define colors for each BM group
palette <- c("High BM" = "#1f77b4", "Low BM" = "#8ac926")

# Create the plot
bm_age_plot <- ggplot() +
  geom_line(data = long_data_vis_bm, aes(x = age, y = memory, group = id), color = "lightgray", alpha = 0.5) + # Plot individual trajectories
  geom_point(data = long_data_vis_bm, aes(x = age, y = memory), color = "gray", size = 1, alpha = 0.8) + # Add scatter points
  geom_ribbon(data = predictions, aes(x = age, ymin = lower_bound, ymax = upper_bound, fill = as.factor(reverse_bm_group)), alpha = 0.3) + # Add CIs
  geom_line(data = predictions, aes(x = age, y = predicted, color = as.factor(reverse_bm_group)), size = 1.2) + # Plot predicted lines for each group
  scale_color_manual(values = palette) +
  scale_fill_manual(values = palette) + # Ensure fill colors match line colors
  labs(
    x = "Age", 
    y = "Memory", 
    color = "Group", 
    fill = "Group", 
    title = "Participants Aging BM-like",
   tag = "A)") +
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.tag = element_text(size = 12), 
        plot.tag.position = c(0.08, 0.055))

# Combine the plots into one figure
combined_lme <- bm_age_plot + cr_age_plot + plot_layout(ncol = 2)
```

__Supplementary Figure 2:__ _The Relationship Between Memory and Age Depicted by CR or BM Group_

```{r fig4, echo=FALSE, dpi = 400, fig.width=6, fig.height=4, message=FALSE, warning=FALSE}
combined_lme
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Get the slopes for BM
slopes_bm <- emtrends(
  model_res_lme_bm,
  specs = ~reverse_bm_group,
  var   = "age"
)

# And for CR
slopes_cr <- emtrends(
  model_res_lme_cr,
  specs = ~reverse_cr_group,
  var   = "age"
)

# Get summary
slopes_bm_summary <- summary(slopes_bm, infer = TRUE)
slopes_cr_summary <- summary(slopes_cr, infer = TRUE)

# Convert to df
slopes_bm_df <- as.data.frame(slopes_bm_summary)
slopes_cr_df <- as.data.frame(slopes_cr_summary)

# Then extract the slope
high_bm_age_unscaled <- slopes_bm_df[slopes_bm_df$reverse_bm_group == "High BM", "age.trend"]
low_bm_age_unscaled <- slopes_bm_df[slopes_bm_df$reverse_bm_group == "Low BM", "age.trend"]
high_cr_age_unscaled <- slopes_cr_df[slopes_cr_df$reverse_cr_group == "High CR", "age.trend"]
low_cr_age_unscaled <- slopes_cr_df[slopes_cr_df$reverse_cr_group == "Low CR", "age.trend"]
```
<small>A) The association between memory and age, among participants aging BM-like, depicted divided into two groups: high BM (blue) representing participants above the mean and low BM (green) representing participants below the mean. There are linear mixed effects models, controlled for all covariates, for each group with the high BM group displaying a coefficient of `r round(high_bm_age_unscaled, 3)` and the low BM group displaying a coefficient of `r round(low_bm_age_unscaled, 3)` and confidence intervals. B) The association between memory and age, among participants aging CR-like, depicted divided into high CR (purple) and low CR (orange) with the high CR group displaying a coefficient of `r round(high_cr_age_unscaled, 3)` and the low CR group displaying a coefficient of `r round(low_cr_age_unscaled, 3)` and confidence intervals. In A) and B), the grey circles represent each participant’s memory scores at baseline and follow-up ages, with grey lines connecting measurements from the same participant.</small>

**_Cross-sectional Cognitive Reserve and Functional Connectivity_**

There was no evidence of a significant association between CR and DMN (_p_ = `r format_p_value(cr_dmn_stats_bl$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_stats_bl", "adjusted_p_value"])`), ECN (_p_ = `r format_p_value(cr_ecn_stats_bl$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_ecn_stats_bl", "adjusted_p_value"])`), or anterior SN connectivity (_p_ = `r format_p_value(cr_sn_stats_bl$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_sn_stats_bl", "adjusted_p_value"])`) at baseline. At follow-up, there was also no evidence of a significant association between CR and ECN (_p_ = `r format_p_value(cr_ecn_stats_fu$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_ecn_stats_fu", "adjusted_p_value"])`) or anterior SN connectivity (_p_ = `r format_p_value(cr_sn_stats_fu$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_sn_stats_fu", "adjusted_p_value"])`). A relationship between CR and DMN connectivity (_p_ = `r format_p_value(cr_dmn_stats_fu$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_stats_fu", "adjusted_p_value"])`) at follow-up did not survive correction for multiple comparisons. Regarding a cross-sectional interaction between functional connectivity and CR, at baseline, there was no evidence of a significant interaction between CR and DMN (_p_ = `r format_p_value(cr_dmn_bl$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_bl", "adjusted_p_value"])`), ECN (_p_ = `r format_p_value(cr_ec_bl$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_ec_bl", "adjusted_p_value"])`) or anterior SN connectivity (_p_ = `r format_p_value(cr_sn_bl$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_sn_bl", "adjusted_p_value"])`) regressed on memory. There was no evidence of a significant interaction between CR and DMN (_p_ = `r format_p_value(cr_dmn_fu$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_fu", "adjusted_p_value"])`), ECN (_p_ = `r format_p_value(cr_ec_fu$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_ec_fu", "adjusted_p_value"])`), or anterior SN connectivity (_p_ = `r format_p_value(cr_sn_fu$p_value)`, _p_<sub>FDR</sub> = `r format_p_value(p_value_df[p_value_df$model_name == "cr_sn_fu", "adjusted_p_value"])`) regressed on memory at follow-up (Supplementary Table 3). 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Create the table
cs_fc <- data.frame(
  " " = c(
    "", "**Cognitive Reserve**",
    "", "", "**Cognitive Reserve**",
    "", "", "**Memory Baseline**",
    "", "", "**Memory Follow-up**"
  ),
  "**DMN Baseline**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(cr_dmn_stats_bl$coef, 3), " (", round(cr_dmn_stats_bl$ci[1], 3), " to ", round(cr_dmn_stats_bl$ci[2], 3), ")"),
    "**DMN Follow-up**", "_Coefficient (95% CI)_",
    paste0(round(cr_dmn_stats_fu$coef, 3), " (", round(cr_dmn_stats_fu$ci[1], 3), " to ", round(cr_dmn_stats_fu$ci[2], 3), ")"),
    "**DMN Baseline * Cognitive Reserve**", "_Coefficient (95% CI)_",
    paste0(round(cr_dmn_bl$coef, 3), " (", round(cr_dmn_bl$ci[1], 3), " to ", round(cr_dmn_bl$ci[2], 3), ")"),
    "**DMN Follow-up * Cognitive Reserve**", "_Coefficient (95% CI)_",
    paste0(round(cr_dmn_fu$coef, 3), " (", round(cr_dmn_fu$ci[1], 3), " to ", round(cr_dmn_fu$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_stats_bl", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_stats_fu", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_bl", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_dmn_fu", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(cr_dmn_stats_bl$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_dmn_stats_fu$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_dmn_bl$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_dmn_fu$adj_r2, 3)
  ),
  "**ECN Baseline**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(cr_ecn_stats_bl$coef, 3), " (", round(cr_ecn_stats_bl$ci[1], 3), " to ", round(cr_ecn_stats_bl$ci[2], 3), ")"),
    "**ECN Follow-up**", "_Coefficient (95% CI)_",
    paste0(round(cr_ecn_stats_fu$coef, 3), " (", round(cr_ecn_stats_fu$ci[1], 3), " to ", round(cr_ecn_stats_fu$ci[2], 3), ")"),
    "**ECN Baseline * Cognitive Reserve **", "_Coefficient (95% CI)_",
    paste0(round(cr_ec_bl$coef, 3), " (", round(cr_ec_bl$ci[1], 3), " to ", round(cr_ec_bl$ci[2], 3), ")"),
    "**ECN Follow-up * Cognitive Reserve**", "_Coefficient (95% CI)_",
    paste0(round(cr_ec_fu$coef, 3), " (", round(cr_ec_fu$ci[1], 3), " to ", round(cr_ec_fu$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_ecn_stats_bl", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_ecn_stats_fu", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_ec_bl", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_ec_fu", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(cr_ecn_stats_bl$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_ecn_stats_fu$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_ec_bl$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_ec_fu$adj_r2, 3)
  ),
  "**Anterior SN Baseline**" = c(
    "_Coefficient (95% CI)_",
    paste0(round(cr_sn_stats_bl$coef, 3), " (", round(cr_sn_stats_bl$ci[1], 3), " to ", round(cr_sn_stats_bl$ci[2], 3), ")"),
    "**Anterior SN Follow-up**", "_Coefficient (95% CI)_",
    paste0(round(cr_sn_stats_fu$coef, 3), " (", round(cr_sn_stats_fu$ci[1], 3), " to ", round(cr_sn_stats_fu$ci[2], 3), ")"),
    "**Anterior SN Baseline * Cognitive Reserve**", "_Coefficient (95% CI)_",
    paste0(round(cr_sn_bl$coef, 3), " (", round(cr_sn_bl$ci[1], 3), " to ", round(cr_sn_bl$ci[2], 3), ")"),
    "**Anterior SN Follow-up * Cognitive Reserve**", "_Coefficient (95% CI)_",
    paste0(round(cr_sn_fu$coef, 3), " (", round(cr_sn_fu$ci[1], 3), " to ", round(cr_sn_fu$ci[2], 3), ")")
  ),
  " " = c(
    "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_sn_stats_bl", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_sn_stats_fu", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_sn_bl", "adjusted_p_value"]),
    "", "_Adjusted p-value_", format_p_value(p_value_df[p_value_df$model_name == "cr_sn_fu", "adjusted_p_value"])
  ),
  " " = c(
    "_Adjusted R²_", round(cr_sn_stats_bl$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_sn_stats_fu$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_sn_bl$adj_r2, 3),
    "", "_Adjusted R²_", round(cr_sn_fu$adj_r2, 3)
  )
)
```

__Supplementary Table 2__: _Cross-sectional Functional Connectivity, Cognitive Reserve and Memory_
```{r suptab3, echo=FALSE} 
# Format and print the table
kable(cs_fc, format = "markdown", col.names = c(" ", "**DMN Baseline**", " ", " ", "**ECN Baseline**", " ", " ", "**Anterior SN Baseline**", " ", " "))
```
Note. Models are adjusted for cohort/MRI scanner. _p_-values are adjusted for multiple comparisons using the FDR. Abbreviations: DMN Default Mode Network, ECN Executive Control Network, SN Salience Network, CI Confidence Interval.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Correcting for p-values

# Cohort comparisons 
cohort_comp <- list(
  age_model, chisq_test, edu_model, 
  mmse_model, fu_time_model, fu_obs_model
)

# Memory, Hippocampus and Analyses
memory_hippocampus_edu_models <- list(
  emhp_merged, model_baseline, model_followup,
  edu_baseline, edu_followup, edu_long
)

# Education and CR/BM Analyses
education_cr_models <- list(
  edu_cr,
  edu_cr_int
)

# CR and BM Sensitivity Analyses
cr_sensitivity_models <- list(
  cr_validation
)

# CR / BM and Age
cr_bm_age_models <- list(
  bm_age_lme, cr_age_lme
)
# Functional Connectivity and CR/BM Analyses Longitudinal
fc_long_cr <- list(
  cr_dmn_stats, cr_dmn,
  cr_ecn_stats, cr_ec,
  cr_sn_stats,  cr_sn
)

# Functional Connectivity and CR/BM Analyses Cross-sectional
fc_cs_cr <- list(
  cr_dmn_bl, cr_dmn_fu, cr_dmn_stats_bl, cr_dmn_stats_fu,
  cr_ec_bl,  cr_ec_fu,  cr_ecn_stats_bl, cr_ecn_stats_fu,
  cr_sn_bl,  cr_sn_fu,  cr_sn_stats_bl,  cr_sn_stats_fu
)

# Duplicate the GAMMs to get seperate p-values
gamm_memory_lft <- gamm_compare_em_memory %>%
  select(p_value_lrt)

gamm_memory_gamm <- gamm_compare_em_memory %>%
  select(p_value_gamm)

gamm_hc_lft <- gamm_compare_em_adj_hc %>%
  select(p_value_lrt)

gamm_hc_gamm <- gamm_compare_em_adj_hc %>%
  select(p_value_gamm)

# Model Comparisons and General Analyses
model_comp_general_models <- list(
  gamm_memory_lft, gamm_memory_gamm,
  gamm_hc_lft, gamm_hc_gamm,
  hc_age_lme, mem_age_lme
)

# Define a function to extract p-values
extract_p_value <- function(model) {
  if ("p_value" %in% names(model)) {
    return(model[["p_value"]])
  } else if ("p_value_gamm" %in% names(model)) {
    return(model[["p_value_gamm"]])
  } else if ("p_value_lrt" %in% names(model)) {
    return(model[["p_value_lrt"]])
  } else {
    return(NULL)
  }
}

adjust_p_values <- function(models, model_names) {
  p_values <- unlist(lapply(models, extract_p_value))
  p_adjusted <- p.adjust(p_values, method = "fdr")

  data.frame(
    model_name = model_names,
    original_p_value = format(p_values, digits = 3, scientific = FALSE, na.encode = TRUE),
    adjusted_p_value = format(p_adjusted, digits = 3, scientific = FALSE, na.encode = TRUE)
  )
}

# Adjust p-values for each group
cohort_comp_p_values <- adjust_p_values(
  cohort_comp, 
  c("age_model", "chisq_test", "edu_model", "mmse_model", "fu_time_model", "fu_obs_model")
)
memory_hippocampus_p_values <- adjust_p_values(
  memory_hippocampus_edu_models,
  c("emhp_merged", "model_baseline", "model_followup", "edu_baseline", "edu_followup", "edu_long")
)
education_cr_p_values <- adjust_p_values(
  education_cr_models,
  c("edu_cr", "edu_cr_int")
)
cr_sensitivity_p_values <- adjust_p_values(
  cr_sensitivity_models,
  c("cr_validation")
)
cr_bm_age_p_values <- adjust_p_values(
  cr_bm_age_models,
  c("bm_age_lme", "cr_age_lme")
)
fc_long_cr_p_values <- adjust_p_values(
  fc_long_cr,
  c("cr_dmn_stats", "cr_dmn", "cr_ecn_stats", "cr_ec", "cr_sn_stats", "cr_sn")
)
fc_cs_cr_p_values <- adjust_p_values(
  fc_cs_cr,
  c(
    "cr_dmn_bl", "cr_dmn_fu", "cr_dmn_stats_bl", "cr_dmn_stats_fu",
    "cr_ec_bl", "cr_ec_fu", "cr_ecn_stats_bl", "cr_ecn_stats_fu",
    "cr_sn_bl", "cr_sn_fu", "cr_sn_stats_bl", "cr_sn_stats_fu"
  )
)
model_comp_general_p_values <- adjust_p_values(
  model_comp_general_models,
  c("gamm_memory_lft", "gamm_memory_gamm", "gamm_hc_lft", "gamm_hc_gamm", "hc_age_lme", "mem_age_lme")
)

# Combine all results
p_value_df <- rbind(
  cohort_comp_p_values,
  memory_hippocampus_p_values,
  education_cr_p_values,
  cr_sensitivity_p_values,
  cr_bm_age_p_values,
  fc_long_cr_p_values,
  fc_cs_cr_p_values,
  model_comp_general_p_values
)

# Output the combined p-values
write.csv(p_value_df, file = "/tsd/p274/data/durable/projects/p027-cr_bm/p_value.csv")
```
